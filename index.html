<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>10 ç§’éŒ„éŸ³ï¼‹å³æ™‚æ³¢å½¢èˆ‡ä¸»é »åˆ†æ</title>
<style>
  :root { --gap: 10px; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto; padding: 16px; }
  h2 { margin: 0 0 12px 0; }
  .toolbar { display: flex; flex-wrap: wrap; gap: var(--gap); margin-bottom: 12px; }
  button { padding: 10px 14px; border: 1px solid #ccc; border-radius: 10px; cursor: pointer; background: #fafafa; }
  button:disabled { opacity: .6; cursor: not-allowed; }
  #status { margin-left: 6px; font-size: 14px; color: #555; }
  .canvases { display: grid; gap: var(--gap); }
  canvas { width: 100%; height: 180px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
  .panel { display: grid; gap: 6px; }
  .freqs { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #fcfcfc; }
  .note { font-size: 12px; color:#666; margin-top: 8px; }
</style>
</head>
<body>
  <h2>è²éŸ³éŒ„è£½èˆ‡ä¸»é »åˆ†æ</h2>

  <div class="toolbar">
    <button id="btnStart">ğŸ¤ éŒ„éŸ³ 10 ç§’</button>
    <button id="btnPause" disabled>â¸ æš«åœæ³¢å½¢</button>
    <button id="btnClear">ğŸ§¹ æ¸…é™¤</button>
    <span id="status"></span>
  </div>

  <div class="canvases">
    <div class="panel">
      <label>å³æ™‚æ³¢å½¢ï¼ˆTime Domainï¼‰</label>
      <canvas id="waveCanvas" width="900" height="220"></canvas>
    </div>
  </div>

  <div class="panel">
    <label>å‰ä¸‰å¤§ä¸»é »ï¼ˆå³æ™‚ï¼‰</label>
    <div id="freqReadout" class="freqs">å°šæœªé–‹å§‹</div>
  </div>
  <div class="note">æç¤ºï¼šå¿…é ˆåœ¨ HTTPS ç¶²ç«™ä¸Šä½¿ç”¨ï¼Œç¬¬ä¸€æ¬¡éŒ„éŸ³æœƒè·³å‡ºéº¥å…‹é¢¨æ¬Šé™è©¢å•ã€‚</div>

<script>
(()=> {
  // --- å…ƒä»¶åƒè€ƒ ---
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnClear = document.getElementById('btnClear');
  const statusEl = document.getElementById('status');
  const waveCanvas = document.getElementById('waveCanvas');
  const wctx = waveCanvas.getContext('2d');
  const freqReadout = document.getElementById('freqReadout');

  // --- ç‹€æ…‹ ---
  let audioCtx = null;
  let analyser = null;
  let mediaStream = null;
  let mediaSource = null;
  let rafId = null;
  let drawFrozen = false;
  let drawingStarted = false;
  let freqTimer = null;
  let mediaRecorder = null;
  let recordTimer = null;

  // è¨­å®š FFT å°ºå¯¸ï¼ˆè§£æåº¦ï¼‰
  const FFT_SIZE = 4096; // è§£æåº¦è¼ƒå¥½ï¼ˆâ‰ˆ sampleRate/4096 Hzï¼‰
  const FREQ_UPDATE_MS = 150; // ä¸»é »æ›´æ–°é »ç‡ï¼ˆæ¯«ç§’ï¼‰

  function setStatus(msg) {
    statusEl.textContent = msg || '';
  }

  function resetAll() {
    // åœæ­¢å‹•ç•«
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    // æ¸…é »ç‡æ›´æ–°
    if (freqTimer) clearInterval(freqTimer);
    freqTimer = null;

    // åœæ­¢éŒ„éŸ³è¨ˆæ™‚
    if (recordTimer) clearTimeout(recordTimer);
    recordTimer = null;

    // åœæ­¢ MediaRecorder
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      try { mediaRecorder.stop(); } catch {}
    }
    mediaRecorder = null;

    // é—œé–‰éŸ³è¨Šä¸²æµ
    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
    }

    // é—œé–‰ AudioContext
    if (audioCtx) {
      try { audioCtx.close(); } catch {}
      audioCtx = null;
    }

    analyser = null;
    mediaSource = null;
    drawingStarted = false;
    drawFrozen = false;

    // UI
    btnPause.textContent = 'â¸ æš«åœæ³¢å½¢';
    btnPause.disabled = true;
    setStatus('');
  }

  function clearScreen() {
    // æ¸…ç•«å¸ƒèˆ‡é »ç‡æ¬„
    wctx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
    freqReadout.textContent = '';
  }

  function drawWaveform() {
    if (!analyser) return;

    const buffer = new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(buffer);

    // èƒŒæ™¯
    wctx.fillStyle = '#ffffff';
    wctx.fillRect(0, 0, waveCanvas.width, waveCanvas.height);

    // ä¸­å¿ƒç·š
    wctx.strokeStyle = '#e6e6e6';
    wctx.lineWidth = 1;
    wctx.beginPath();
    wctx.moveTo(0, waveCanvas.height/2);
    wctx.lineTo(waveCanvas.width, waveCanvas.height/2);
    wctx.stroke();

    // æ³¢å½¢
    wctx.strokeStyle = '#000000';
    wctx.lineWidth = 2;
    wctx.beginPath();

    const slice = waveCanvas.width / buffer.length;
    let x = 0;
    for (let i = 0; i < buffer.length; i++) {
      const v = buffer[i] / 128.0; // 0..255 -> around 1.0 at center
      const y = (v * waveCanvas.height/2);
      if (i === 0) wctx.moveTo(x, y);
      else wctx.lineTo(x, y);
      x += slice;
    }
    wctx.stroke();

    if (!drawFrozen) {
      rafId = requestAnimationFrame(drawWaveform);
    }
  }

  function smoothArray(arr, windowSize=3) {
    const out = new Float32Array(arr.length);
    const half = Math.floor(windowSize/2);
    for (let i=0;i<arr.length;i++){
      let sum = 0, cnt = 0;
      for (let k = -half; k <= half; k++){
        const idx = i + k;
        if (idx >=0 && idx < arr.length) { sum += arr[idx]; cnt++; }
      }
      out[i] = sum / cnt;
    }
    return out;
  }

  function topFrequencies(analyser, sampleRate, topN = 3) {
    const N = analyser.frequencyBinCount; // = FFT_SIZE/2
    const freqData = new Uint8Array(N);
    analyser.getByteFrequencyData(freqData);

    // è½‰ Float ä¸¦ç•¥åšå¹³æ»‘ï¼Œéæ¿¾é›œè¨Š
    const floatArr = Float32Array.from(freqData, v => v);
    const smoothed = smoothArray(floatArr, 5);

    // å¿½ç•¥ DCï¼ˆ0 Hzï¼‰èˆ‡å¾ˆé«˜é »å™ªè²ï¼Œå¯ç”¨ç¯„åœ 20Hz ~ 8000Hzï¼ˆèªéŸ³å¸¸è¦‹ä¸»æˆåˆ†ï¼‰
    const minHz = 20;
    const maxHz = Math.min(8000, sampleRate / 2);
    const binHz = sampleRate / FFT_SIZE;

    let candidates = [];
    let totalAmp = 0;

    for (let i = 0; i < N; i++) {
      const hz = i * binHz;
      const amp = Math.max(0, smoothed[i]);
      if (hz >= minHz && hz <= maxHz) {
        candidates.push({ i, hz, amp });
        totalAmp += amp;
      }
    }

    if (totalAmp <= 0) {
      return { list: [], totalAmp: 0 };
    }

    // æ‰¾ã€Œå±€éƒ¨å³°å€¼ã€
    const peaks = [];
    for (let k = 1; k < candidates.length - 1; k++) {
      const a = candidates[k-1].amp, b = candidates[k].amp, c = candidates[k+1].amp;
      if (b > a && b >= c) {
        peaks.push(candidates[k]);
      }
    }

    // ä¾å¼·åº¦æ’åº
    peaks.sort((p, q) => q.amp - p.amp);

    // åˆä½µå½¼æ­¤å¤ªæ¥è¿‘çš„å³°ï¼ˆé¿å…åŒä¸€ä¸»é »è¢«å¤šå€‹ç›¸é„° bin åƒåˆ°ï¼‰
    const merged = [];
    const minSepHz = binHz * 3; // è‡³å°‘é–“éš”å¹¾å€‹ bin
    peaks.forEach(p => {
      if (!merged.some(m => Math.abs(m.hz - p.hz) < minSepHz)) merged.push(p);
    });

    // å–å‰ topN
    const top = merged.slice(0, topN);

    // ä½”æ¯”ï¼ˆç›¸å°æ–¼ç¸½èƒ½é‡ï¼‰
    const list = top.map(item => ({
      hz: item.hz,
      ratio: (item.amp / totalAmp)
    }));

    return { list, totalAmp };
  }

  function updateFreqReadout() {
    if (!analyser || !audioCtx) return;
    const { list } = topFrequencies(analyser, audioCtx.sampleRate, 3);
    if (!list.length) {
      freqReadout.textContent = 'ï¼ˆåµæ¸¬ä¸­â€¦ å°šç„¡é¡¯è‘—ä¸»é »ï¼‰';
      return;
    }
    const lines = list.map((f, idx) =>
      `#${idx+1}  ${f.hz.toFixed(1).padStart(7)} Hz    ä½”æ¯”ï¼š${(f.ratio*100).toFixed(2)}%`
    );
    freqReadout.textContent = lines.join('\n');
  }

  async function startRecording10s() {
    resetAll();
    clearScreen();

    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
      setStatus('ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼š' + err.message);
      return;
    }

    // Audio Graph
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    mediaSource = audioCtx.createMediaStreamSource(mediaStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = FFT_SIZE;
    analyser.smoothingTimeConstant = 0.85; // ç¨å¾®å¹³æ»‘

    mediaSource.connect(analyser);

    // é–‹å§‹å³æ™‚ç¹ªåœ–
    drawFrozen = false;
    drawingStarted = true;
    rafId = requestAnimationFrame(drawWaveform);

    // å³æ™‚ä¸»é »æ›´æ–°
    updateFreqReadout();
    freqTimer = setInterval(updateFreqReadout, FREQ_UPDATE_MS);

    // MediaRecorderï¼ˆå¦‚éœ€å¯¦éš›ä¿å­˜éŒ„éŸ³ï¼Œå¯åœ¨ onstop å–å¾— blobï¼‰
    if (window.MediaRecorder) {
      mediaRecorder = new MediaRecorder(mediaStream);
      const chunks = [];
      mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };
      mediaRecorder.onstop = () => {
        // ä½ å¯é¸æ“‡æä¾›ä¸‹è¼‰ï¼š
        // const blob = new Blob(chunks, { type: 'audio/webm' });
        // const url = URL.createObjectURL(blob);
        // setStatus('å·²éŒ„è£½ 10 ç§’ã€‚'); // æˆ–é¡¯ç¤ºä¸‹è¼‰é€£çµ
      };
      mediaRecorder.start();
    }

    // UI ç‹€æ…‹
    btnPause.disabled = false;
    btnPause.textContent = 'â¸ æš«åœæ³¢å½¢';
    setStatus('éŒ„éŸ³ä¸­â€¦ï¼ˆè‡ªå‹•æ–¼ 10 ç§’çµæŸï¼‰');

    // 10 ç§’å¾Œè‡ªå‹•åœæ­¢
    recordTimer = setTimeout(() => {
      // åœæ­¢åœ–èˆ‡é »ç‡æ›´æ–°ï¼Œä½†ä¿ç•™æœ€å¾Œä¸€å¹€ï¼ã€Œå‡çµã€
      drawFrozen = true;
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      if (freqTimer) clearInterval(freqTimer);
      freqTimer = null;

      // åœæ­¢éŒ„éŸ³ã€é—œé–‰ä¸²æµ
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        try { mediaRecorder.stop(); } catch {}
      }
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }
      setStatus('å·²è‡ªå‹•çµæŸéŒ„éŸ³ï¼ˆ10 ç§’ï¼‰ã€‚');
    }, 10000);
  }

  // --- äº‹ä»¶ç¹«çµ ---
  btnStart.addEventListener('click', startRecording10s);

  btnPause.addEventListener('click', () => {
    if (!drawingStarted) return;
    drawFrozen = !drawFrozen;
    if (!drawFrozen) {
      btnPause.textContent = 'â¸ æš«åœæ³¢å½¢';
      rafId = requestAnimationFrame(drawWaveform);
      if (!freqTimer) freqTimer = setInterval(updateFreqReadout, FREQ_UPDATE_MS);
      setStatus('æŒçºŒæ›´æ–°ä¸­â€¦');
    } else {
      btnPause.textContent = 'â–¶ï¸ ç¹¼çºŒæ³¢å½¢';
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      if (freqTimer) clearInterval(freqTimer);
      freqTimer = null;
      setStatus('å·²å‡çµæ³¢å½¢ã€‚');
    }
  });

  btnClear.addEventListener('click', () => {
    resetAll();
    clearScreen();
    setStatus('å·²æ¸…é™¤ç•«é¢ã€‚');
    freqReadout.textContent = '';
  });
})();
</script>
</body>
</html>
